"use strict";const fs=require("fs"),vm=require("vm"),v8=require("v8"),path=require("path"),Module=require("module");v8.setFlagsFromString("--no-lazy"),Number.parseInt(process.versions.node.split(".")[0],10)>=12&&v8.setFlagsFromString("--no-flush-bytecode");const COMPILED_EXTNAME=".jsc",compileCode=function(e){if("string"!=typeof e)throw new Error(`javascriptCode must be string. ${typeof e} was given.`);let t=new vm.Script(e,{produceCachedData:!0});return t.createCachedData&&t.createCachedData.call?t.createCachedData():t.cachedData},fixBytecode=function(e){if(!Buffer.isBuffer(e))throw new Error("bytecodeBuffer must be a buffer object.");let t=compileCode('"ಠ_ಠ"');process.version.startsWith("v8.8")||process.version.startsWith("v8.9")?(t.slice(16,20).copy(e,16),t.slice(20,24).copy(e,20)):process.version.startsWith("v12")||process.version.startsWith("v13")||process.version.startsWith("v14")||process.version.startsWith("v15")?t.slice(12,16).copy(e,12):(t.slice(12,16).copy(e,12),t.slice(16,20).copy(e,16))},readSourceHash=function(e){if(!Buffer.isBuffer(e))throw new Error("bytecodeBuffer must be a buffer object.");return process.version.startsWith("v8.8")||process.version.startsWith("v8.9")?e.slice(12,16).reduce((e,t,r)=>e+=t*Math.pow(256,r),0):e.slice(8,12).reduce((e,t,r)=>e+=t*Math.pow(256,r),0)},runBytecode=function(e){if(!Buffer.isBuffer(e))throw new Error("bytecodeBuffer must be a buffer object.");fixBytecode(e);let t=readSourceHash(e),r="";t>1&&(r='"'+"​".repeat(t-2)+'"');let o=new vm.Script(r,{cachedData:e});if(o.cachedDataRejected)throw new Error("Invalid or incompatible cached data (cachedDataRejected)");return o.runInThisContext()},compileFile=function(e,t){let r,o;if("string"==typeof e?(r=e,o=!0):"object"==typeof e&&(r=e.filename,o=!1!==e.compileAsModule),"string"!=typeof r)throw new Error(`filename must be a string. ${typeof r} was given.`);let s=e.output||t||r.slice(0,-3)+".jsc";if("string"!=typeof s)throw new Error(`output must be a string. ${typeof s} was given.`);let i,c=fs.readFileSync(r,"utf-8");return i=compileCode(o?Module.wrap(c.replace(/^#!.*/,"")):c.replace(/^#!.*/,"")),fs.writeFileSync(s,i),s},runBytecodeFile=function(e){if("string"!=typeof e)throw new Error(`filename must be a string. ${typeof e} was given.`);let t=fs.readFileSync(e);return runBytecode(t)};Module._extensions[".jsc"]=function(e,t){let r=fs.readFileSync(t);fixBytecode(r);let o=readSourceHash(r),s="";o>1&&(s='"'+"​".repeat(o-2)+'"');let i=new vm.Script(s,{filename:t,lineOffset:0,displayErrors:!0,cachedData:r});if(i.cachedDataRejected)throw new Error("Invalid or incompatible cached data (cachedDataRejected)");function c(t){return e.require(t)}c.resolve=function(t,r){return Module._resolveFilename(t,e,!1,r)},c.main=process.mainModule,c.extensions=Module._extensions,c.cache=Module._cache;let n=i.runInThisContext({filename:t,lineOffset:0,columnOffset:0,displayErrors:!0}),a=path.dirname(t),l=[e.exports,c,e,t,a,process,global];return n.apply(e.exports,l)},global.bytenode={compileCode:compileCode,compileFile:compileFile,runBytecode:runBytecode,runBytecodeFile:runBytecodeFile},module.exports=global.bytenode;